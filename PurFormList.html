<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>供应商管理</title>
    <link rel="stylesheet" type="text/css" href="easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="easyui/themes/color.css">
    <link rel="stylesheet" type="text/css" href="easyui/themes/xyy.css">
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="easyui/easyloader.js"></script>
    <script type="text/javascript" src="easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="easyui/locale/easyui-lang-zh_CN.js"></script>
    
    <style>
       .tabs-header{
           display: none !important;
       }
       .tabs-wrap{
          display: none !important;
       }
        #dlg{
            width: 970px !important;
            height: 400px !important;
        }
        #add{
            width: 970px !important;
            height: 440px !important;
        }


        .messager-window{
            width: 200px !important;
       }
        .fitem60{
            margin-top: 45px;
        }
        .fitem61{
            margin-top: 45px;
            margin-left: 220px;
        }
        .fitem62{
            margin-top: 45px;
            margin-left: 470px;
        }
        .fitem63{
            margin-top: 45px;
            margin-left: 710px;
        }
       .fitem64{
           margin-top: 85px;
       }
       .fitem65{
            margin-top: 85px;
            margin-left: 710px;
       }
       .fitem66{
            margin-top: 120px;
       }
       .fitem67{
            margin-top: 400px;
       }
       .fitem68{
            margin-top: 400px;
            margin-left: 150px;
       }
       .fitem69{
            margin-top: 400px;
            margin-left: 320px;
       }
       .fitem70{
            margin-top: 400px;
            margin-left: 470px;
       }
       .fitem71{
            margin-top: 400px;
            margin-left: 640px;
       }
       .fitem72{
            margin-top: 400px;
            margin-left: 805px;
       }
       #save1{
           position: absolute;
           margin-top: 10px;
           background: #19aa8d;
       }
       #closes{
           position: absolute;
           margin-top: 10px;
           margin-left: 50px;
           background: #00CDCD;
       }





        .fitem1{
            margin-left: 210px;
        }
        .fitem2{
            margin-left: 472px;
        }
        .fitem3{
            margin-left: 700px;
        }
       .fitem4{
           margin-top: 40px;
       }
       .fitem40{
           margin-top: 50px;
       }
       .fitem5{
           margin-top: 40px;
           margin-left: 210px;
       }
       .fitem6{
           margin-top: 40px;
           margin-left: 460px;
       }
       .fitem7{
           margin-top: 40px;
           margin-left: 700px;
       }
       .fitem8{
           margin-top: 80px;
       }
       .fitem9{
           margin-top: 80px; 
           margin-left: 210px;
       }
       .fitem10{
           margin-top: 80px; 
           margin-left: 462px;
       }
       .fitem11{
           margin-top: 80px; 
           margin-left: 700px;
       }
       .fitem12{
           margin-top: 120px;
       }
       .fitem33{
           margin-top: 500px;
       }
       .fitem55{
        margin-top: 100px;
       }
       .fitem13{
           margin-top: 350px;
       }
       .fitem14{
           margin-top: 350px;
           margin-left: 220px;
       }
       .fitem15{
           margin-top: 350px;
           margin-left: 472px;
       }
       .fitem16{
           margin-top: 350px;
           margin-left: 700px;
       }.fitem17{
           margin-top: 180px;
       }
       .fitem18{
           margin-top: 180px;
           margin-left: 235px;
       }
       .fitem19{
           margin-top: 180px;
           margin-left: 462px;
       }
       .fitem20{
           margin-top: 180px;
           margin-left: 725px;
       }
       .fitem21{
           margin-top: 240px;     
       }
       .fitem22{
           margin-top: 240px;  
           margin-left: 460px;
       }
       .aaa {
            width: 1100px !important;
       }
       #file{
           height: 400px !important;
       }
       #save{
           position: absolute;
           margin-top: 450px;
           margin-left: 460px;
           background: #19aa8d;
       }
    </style>
</head>
<body class="easyui-layout" style="margin:0 1px;background-color:#f5f5f5 !important;">   
    <div data-options="region:'center'" style="background:#fff;border:0;">
	    <div id="tb" class="easyui-tabs" data-options="tools:'#tab-tools',fit:true">
			<div title="">
		        <div class="easyui-layout" data-options="fit:true">
					<div data-options="region:'center',border:false">
						<div data-options="region:'center',border:false"></div>
                            <table id="datagrid" class="easyui-datagrid" style="width:100%;height:100%;"
                                data-options="rownumbers:true,showFooter:true,pagination:true,pageSize:50,singleSelect:false,
                                collapsible:true,toolbar:'#toolbar',method:'get',
                                checkOnSelect:'true',selectOnCheck:'true',">
							<!---获取数据--->
							<thead>
								<tr>
                                    <!-- <th field="puOrderId" checkbox="true"></th> -->
                                    <th data-options="field:'chkState',width:100, align: 'center', halign: 'center',formatter:format_check">审核状态</th>
									<th data-options="field:'closeState',width:80, align: 'center', halign: 'center',formatter:format_close">行状态</th>							
									<th data-options="field:'contractNo',width:100, align: 'left', halign: 'center'">合同号</th>
                                    <th data-options="field:'puOrderDate1',width:100, align: 'center', halign: 'center'">采购日期</th>
                                    <th data-options="field:'itemNo',width:100, align: 'left', halign: 'center'">物料代码</th>
                                    <th data-options="field:'supName',width:250, align: 'left', halign: 'center'">供应商名称</th>
                                    <th data-options="field:'itemName',width:200, align: 'left', halign: 'center'">物料名称</th>
                                    <th data-options="field:'itemSize',width:250, align: 'left', halign: 'center'">规格型号</th>
                                    <th data-options="field:'showUnit',width:100, align: 'center', halign: 'center'">单位</th>
                                    <th data-options="field:'showNum',width:100, align: 'right', halign: 'center',formatter:twoNumber">采购数量</th>
                                    <th data-options="field:'taxPrice',width:100, align: 'right', halign: 'center',formatter:thousandBit">单价</th>
                                    <th data-options="field:'leviedTotal',width:100, align: 'right', halign: 'center',formatter:twoNumber">总金额</th>
                                    <th data-options="field:'noRnNum',width:100, align: 'right', halign: 'center',formatter:twoNumber">未下推量</th>
                                    <th data-options="field:'payCurrency',width:100, align: 'center', halign: 'center',formatter:fmt_payCurrency">结算币种</th>
                                    <th data-options="field:'giveDate1',width:100, align: 'center', halign: 'center'">交货日期</th>
                                    <th data-options="field:'makeManName',width:100, align: 'center', halign: 'center'">制单人</th>
								</tr>
                            </thead>
							</table>
							<div id="toolbar">
                                <div class="col-md-2 col-sm-6">  
                                    <a class="easyui-linkbutton" data-options="iconCls:'icon-back'" onclick="createShouNotice()">下推收料通知单</a>
                                    <a class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="upload()">附件上传</a>
                                </div>
                                <div style="margin-top: 5px; margin-bottom: 5px;">
                                    <div class="col-md-2 col-sm-6">
                                        <div class="input-append">
                                            <span class="add-on">采购日期</span>
                                            <input type="datetime" id="begindate" name="begindate" data-options="editable:false,formatter:myformatter,parser:myparser" class="easyui-datebox" style="width: 100px;"/>
                                            <span class="add-on">-</span>
                                            <input type="datetime" id="enddate" name="enddate" data-options="editable:false,formatter:myformatter,parser:myparser" class="easyui-datebox" style="width: 100px;"/>
                                            
                                            <a class="easyui-linkbutton" plain="true" style="display: none;">
                                                <span>审核状态: </span>
                                                <select id="chkState" name="chkState" onchange="$('#dg').datagrid({singleSelect:(this.value==1)})" style="height: 24px;">
                                                    <option value="99">全部</option>
                                                    <option value="0">待送审</option>
                                                    <option value="1" selected="selected">通过</option>
                                                    <option value="2">审核中</option>
                                                    <option value="3">不通过</option>
                                                </select>
                                            </a>

                                            <a class="easyui-linkbutton" plain="true">
                                                <span>作废状态: </span>
                                                <select id="isCancel" name="isCancel" onchange="$('#dg').datagrid({singleSelect:(this.value==1)})" style="height: 24px;">
                                                    <option value="99">全部</option>
                                                    <option value="0" selected="selected">正常</option>
                                                    <option value="1">作废</option>
                                                </select>
                                            </a>

                                            <a class="easyui-linkbutton" plain="true">
                                                <span>行状态: </span>
                                                <select id="closeState" name="closeState" onchange="$('#dg').datagrid({singleSelect:(this.value==1)})" style="height: 24px;">
                                                    <option value="99">全部</option>
                                                    <option value="0" selected="selected">开启</option>
                                                    <option value="1">关闭</option>
                                                </select>
                                            </a>
                                            <a class="easyui-linkbutton" plain="true">
                                                <label>物料代码:</label>
                                                <input id="itemNo" name="itemNo" class="easyui-validatebox" style="height: 18px;">
                                            </a>
                                            <!-- <a href="#" class="easyui-linkbutton" plain="true">
                                                <label>物料名称:</label>
                                                <input id="itemSize" name="itemSize" class="easyui-validatebox" style="height: 18px;">
                                            </a> -->
                                            <a class="easyui-linkbutton" plain="true">
                                                <label>合同号:</label>
                                                <input id="contractNo" name="contractNo" class="easyui-validatebox" style="height: 18px;">
                                            </a>

                                            <a class="easyui-linkbutton" plain="true">
                                                <label>规格型号:</label>
                                                <input id="itemSize" name="itemSize" class="easyui-validatebox" style="height: 18px;">
                                            </a>

                                            <a class="easyui-linkbutton" plain="true">
                                                <label>制单人:</label>
                                                <input id="makeManName" name="makeManName" class="easyui-validatebox" style="height: 18px;width: 100px;">
                                            </a>
                                            <button class="easyui-linkbutton" iconCls="icon-search" plain="true"  onclick="select()"></button>
                                            <button class="easyui-linkbutton" plain="true"  onclick="tjClear()">复位</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
						</div>
					</div>
				</div>
            </div>
            <div id="dlg" title="采购单编辑" class="easyui-dialog" style="width:980px;height:600px;padding:10px 20px" closed="true" buttons="#dlg-buttons">
                <form id="fm" novalidate style="position: relative;">
                    <div class="fitem" style="width: 500px !important;position: absolute;">
                        <label>供应商名称:</label>
                        <input id="supName1" name="supName1" class="easyui-validatebox" style="width:360px;" readonly="readonly">
                    </div>
                    <div class="fitem2" style="width: 300px !important;position: absolute;">
                        <label>合同号:</label>
                        <input id="contractNo1" name="contractNo1" class="easyui-validatebox" readonly="readonly">
                    </div>
                    <div class="fitem3" style="width: 230px !important;position: absolute;">
                        <label>签订日期:</label>
                        <input type="datetime" id="puOrderDate" name="puOrderDate" readonly="readonly" data-options="editable:false,formatter:myformatter,parser:myparser" class="easyui-datebox" style="width: 170px;"/>
                    </div>
                    <div class="fitem4" style="width: 300px !important;position: absolute;">
                        <label>采购人员:</label>
                        <input id="purcManName" name="purcManName" class="easyui-validatebox" style="width:140px;" readonly="readonly">
                        <!-- <button class="btn" type="button" onclick=""><i class="icon-th"></i></button> -->
                    </div>
                    <div class="fitem5" style="width: 300px !important;position: absolute;">
                        <label>付款条件:</label>
                        <select id="payCondition" name="payCondition" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;" readonly="readonly">
                        </select>
                    </div>
                    <div class="fitem6" style="width: 300px !important;position: absolute;">
                        <label>送货地址:</label>
                        <select id="tranAddress" name="tranAddress"style="width: 170px;height: 22px;" disabled="disabled">
                            <option value="福州生产基地" selected="selected">福州生产基地</option>
                            <option value="福州火车东站">福州火车东站</option>
                            <option value="福州马尾港">福州马尾港</option>
                            <option value="福州物流点">福州物流点</option>
                        </select>
                    </div>
                    <div class="fitem7" style="width: 230px !important;position: absolute;">
                        <label>运输方式:</label>
                        <select id="tranType" name="tranType" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;" readonly="readonly">
                        </select>
                    </div>
                    <div class="fitem8" style="width: 300px !important;position: absolute;">
                        <label>提货方式:</label>
                        <select id="takeWay" name="takeWay" class="zhi_selector easyui-combobox" style="width: 150px;height: 22px;"readonly="readonly">
                            
                        </select>
                    </div>            
                    <div class="fitem9" style="width: 300px !important;position: absolute;">
                        <label>运输费用:</label>
                        <select id="deliveryType" name="deliveryType" style="width: 170px;height: 22px;" disabled="disabled">
                            <option value="1">供应商付费</option>
                            <option value="0">思嘉付费</option>
                        </select>
                    </div>
                    <div class="fitem10" style="width: 300px !important;position: absolute;">
                        <label>结算方式:</label>
                        <select id="payType" name="payType" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;" readonly="readonly">
                        </select>
                    </div>
                    <div class="fitem11" style="width: 230px !important;position: absolute;">
                        <label>发票类型:</label>
                        <select id="invoiceType" name="invoiceType" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;" readonly="readonly">
                            
                        </select>
                    </div>
                    <div class="fitem17" style="width: 300px !important;position: absolute;">
                        <label>开票方式:</label>
                        <select id="makeWay" name="makeWay" style="width: 150px;height: 22px;" readonly="readonly">
                            <option value="" style="display: none;"></option>
                            <option value="1">一票制</option>
                            <option value="2">两票制</option>
                        </select>
                    </div>
                    <div class="fitem18" style="width: 300px !important;position: absolute;">
                        <label>运费:</label>
                        <input id="freight" name="freight" step="0.01" class="easyui-validatebox" readonly="readonly">
                    </div>
                    <div class="fitem19" style="width: 300px !important;position: absolute;">
                        <label>结算币种:</label>
                        <select id="payCurrency" name="payCurrency" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;" readonly="readonly">
                            
                        </select>
                    </div>
                    <div class="fitem20" style="width: 250px !important;position: absolute;">
                        <label>备注:</label>
                        <input id="remark" name="remark" class="easyui-validatebox" readonly="readonly">
                    </div>
                    <div class="fitem21" style="width: 450px !important;position: absolute;">
                        <label>技术/指标要求:</label>
                        <input id="requirement" name="requirement" class="easyui-validatebox" style="width: 345px;" readonly="readonly">
                    </div>
                    <div class="fitem22" style="width: 500px !important;position: absolute;">
                        <label>包装标准:</label>
                        <input id="packing" name="packing" class="easyui-validatebox" style="width: 400px;" readonly="readonly">
                    </div>
                    <div class="fitem12" style="width: 100% !important;position: absolute;">
                        <table id="datagrid1" class="easyui-datagrid" data-options="rownumbers:true,singleSelect:true" nowrap="true" style="width: 100%; height:210px;">
                        </table>
                    </div>   
                    <div class="fitem13" style="width: 300px !important;position: absolute;">
                        <label>制单人:</label>
                        <input id="makeManName1" name="makeManName1" class="easyui-validatebox" readonly="readonly" style="width: 162px;">
                    </div>
                    <div class="fitem14" style="width: 300px !important;position: absolute;">
                        <label>制单日期:</label>
                        <input id="createDate" name="createDate" class="easyui-validatebox" readonly="readonly" style="width: 160px;">
                    </div>
                    <div class="fitem15" style="width: 300px !important;position: absolute;">
                        <label>审核人:</label>
                        <input id="chkManName" name="chkManName" class="easyui-validatebox" readonly="readonly" style="width: 162px;">
                    </div>
                    <div class="fitem16" style="width: 230px !important;position: absolute;">
                        <label>审核日期:</label>
                        <input id="chkTime" name="chkTime" class="easyui-validatebox" readonly="readonly" style="width: 160px;">
                    </div>            
                </form>
            </div>
            <div id="add" title="下推收料通知单" class="easyui-dialog" style="width:970px;height:470px;padding:10px 20px" closed="true" buttons="#dlg-buttons">
                <form id="fm" novalidate style="position: relative;">
                    <div class="fitem60" style="width: 300px !important;position: absolute;">
                        <label>单号:</label>
                        <input id="rnNo" name="rnNo" class="easyui-validatebox" readonly="readonly">
                    </div>
                    <div class="fitem61" style="width: 240px !important;position: absolute;">
                        <label>预收日期:</label>
                        <input type="datetime" id="AHDate1" name="AHDate1" data-options="editable:false,formatter:myformatter,parser:myparser" class="easyui-datebox" />
                    </div>
                    <div class="fitem62" style="width: 300px !important;position: absolute;">
                        <label>车牌号:</label>
                        <input id="plateNumbers" name="plateNumbers" class="easyui-validatebox" >
                    </div>
                    <div class="fitem63" style="width: 240px !important;position: absolute;">
                        <label>司机电话:</label>
                        <input id="driverPhone" name="driverPhone" class="easyui-validatebox">
                    </div>
                    <div class="fitem64" style="width: 940px !important;position: absolute;">
                        <label>备注:</label>
                        <input id="remark1" name="remark1" class="easyui-validatebox" style="width: 895px;">
                    </div>
                    
                    <div class="fitem65" style="width: 300px !important;position: absolute;display: none;">
                        <label>单据日期:</label>
                        <input type="datetime" id="rnDate1" name="rnDate1" data-options="editable:false,formatter:myformatter,parser:myparser" class="easyui-datebox" />
                    </div>
                    <div class="fitem5" style="width: 300px !important;position: absolute;display: none;">
                        <label>付款条件:</label>
                        <select id="payCondition1" name="payCondition1" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;">
                        </select>
                    </div>
                    <div class="fitem6" style="width: 300px !important;position: absolute;display: none">
                        <label>送货地址:</label>
                        <select id="tranAddress1" name="tranAddress1"style="width: 170px;height: 22px;">
                            <option value="福州生产基地" selected="selected">福州生产基地</option>
                            <option value="福州火车东站">福州火车东站</option>
                            <option value="福州马尾港">福州马尾港</option>
                            <option value="福州物流点">福州物流点</option>
                        </select>
                    </div>
                    <div class="fitem7" style="width: 300px !important;position: absolute;display: none">
                        <label>运输方式:</label>
                        <select id="tranType1" name="tranType1" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;">
                        </select>
                    </div>
                    <div class="fitem8" style="width: 300px !important;position: absolute;display: none">
                        <label>提货方式:</label>
                        <select id="takeWay1" name="takeWay1" class="zhi_selector easyui-combobox" style="width: 150px;height: 22px;">
                            
                        </select>
                    </div>            
                    <div class="fitem9" style="width: 300px !important;position: absolute;display: none">
                        <label>运输费用:</label>
                        <select id="deliveryType1" name="deliveryType1" style="width: 170px;height: 22px;">
                            <option value="1">供应商付费</option>
                            <option value="0">思嘉付费</option>
                        </select>
                    </div>
                    <div class="fitem10" style="width: 300px !important;position: absolute;display: none">
                        <label>结算方式:</label>
                        <select id="payType1" name="payType1" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;">
                        </select>
                    </div>
                    <div class="fitem11" style="width: 300px !important;position: absolute;display: none">
                        <label>发票类型:</label>
                        <select id="invoiceType1" name="invoiceType1" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;">
                            
                        </select>
                    </div>
                    <div class="fitem17" style="width: 300px !important;position: absolute;display: none">
                        <label>开票方式:</label>
                        <select id="makeWay1" name="makeWay1" style="width: 150px;height: 22px;">
                            <option value="" style="display: none;"></option>
                            <option value="1">一票制</option>
                            <option value="2">两票制</option>
                        </select>
                    </div>
                    <div class="fitem18" style="width: 300px !important;position: absolute;display: none">
                        <label>运费:</label>
                        <input id="freight1" name="freight1" step="0.01" class="easyui-validatebox">
                    </div>
                    <div class="fitem19" style="width: 300px !important;position: absolute;display: none">
                        <label>结算币种:</label>
                        <select id="payCurrency1" name="payCurrency1" class="zhi_selector easyui-combobox" style="width: 170px;height: 22px;">    
                        </select>
                    </div>
                    
                    
                    <div class="fitem66" style="width: 100% !important;position: absolute;">
                        <table id="datagrid4" class="easyui-datagrid" data-options="rownumbers:true,singleSelect:true" nowrap="true" style="width: 100%; height:260px;">
                            </thead>
                        </table>
                    </div>
                    <div class="fitem67" style="width: 300px !important;position: absolute;">
                        <label>制单人:</label>
                        <input id="makeManName2" name="makeManName2" class="easyui-validatebox" readonly="readonly" style="width: 80px;">
                    </div>
                    <div class="fitem68" style="width: 300px !important;position: absolute;">
                        <label>制单日期:</label>
                        <input id="createDate1" name="createDate1" class="easyui-validatebox" readonly="readonly" style="width: 80px;">
                    </div>
                    <div class="fitem71" style="width: 300px !important;position: absolute;">
                        <label>修改日期:</label>
                        <input id="chkTime1" name="chkTime1" class="easyui-validatebox" readonly="readonly" style="width: 80px;">
                    </div>
                    <div class="fitem72" style="width: 140px !important;position: absolute;">
                        <label>修改人:</label>
                        <input id="chkManName1" name="chkManName1" class="easyui-validatebox" readonly="readonly" style="width: 80px;">
                    </div>    
                    <div class="fitem69" style="width: 300px !important;position: absolute;">
                        <label>审核人:</label>
                        <input id="chkManName1" name="chkManName1" class="easyui-validatebox" readonly="readonly" style="width: 80px;">
                    </div>
                    <div class="fitem70" style="width: 230px !important;position: absolute;">
                        <label>审核日期:</label>
                        <input id="chkTime1" name="chkTime1" class="easyui-validatebox" readonly="readonly" style="width: 80px;">
                    </div>
                    <div>
                        <button class="btn" id="save1" type="button" onclick="XTsave()">保存</button>
                        <button class="btn" id="closes" type="button" onclick="closesd()">取消</button>
                   </div>
                </form>
            </div>
            <div id="file" title="附件上传" class="easyui-dialog" closed="true" style="height: 470px;width: 970px;">
                <div id="lefts" style="width: 50%;position: absolute;height: 420px;">
                    <iframe id="upl" name="upl" frameborder="0" style="width: 400px;height: 400px;margin-left: 40px;"></iframe>
                 </div>
                 <div id="rights" style="width: 50%;position: absolute;margin-left: 50%;height: 400px;">
                    <div data-options="region:'',split:true" style="height: 400px;">
                        <table class="easyui-datagrid" id="datagrid2" nowrap="true" style="height: 400px;">
                            <thead>
                                <tr>
                                    <th field="puOrderId" checkbox="true"></th>
                                    <th data-options="field:'filename',width:185, align: 'left', halign: 'center'">文件名</th>
                                    <th data-options="field:'ftype',width:60,align:'center'">类型</th>
                                    <th data-options="field:'fdataType',width:80,align:'center',formatter:fileType">文件类型</th>
                                    <th data-options="field:'UName',width:90,align:'center'">上传用户</th>
                                    <th data-options="field:'createdate',width:120,align:'center'">上传时间</th>
                                    <th data-options="field:'fid',width:80,align:'center', formatter: operate">操作</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                 </div>
            </div>
	</div>
<script type="text/javascript">	
    //附件刷新页面
    function Refresh(){
        var rowData = $('#datagrid').datagrid('getSelected');
        var formId = rowData.puOrderId;
        $.ajax({
            url:'http://192.168.16.198:8866/erp/Document/GetDocumentInfo?formId='+ formId +'&formKey=Purc_PurFormList',
            type:'get',
            success: function (data) {
                // alert("ok");
                        var obj = {"total":data.Data.length,"rows":data.Data};   
                        $('#datagrid2').datagrid('loadData',obj);
                },
                error: function (e) {
                    $.messager.alert({
                            title : '提示信息!',
                            msg : '失败!!'
                        });
                },
        })
    }
    //附件批量删除
    function dele(){
        var endRows = $('#datagrid2').datagrid("getRows");
        if (endRows.length < 1) {
            $.messager.alert({
                title : '提示信息!',
                msg : '请选择需要删除的附件！!'
            });
            return false;
        }
        var rows = $("#datagrid2").datagrid("getSelections"); 
        var PointIds=[];
        for (var i = 0; i < rows.length; i++) {
        PointIds.push(rows[i].fid);
        }
        PointIds.join(',');
        console.log(PointIds);
        var data1 = PointIds;
        $.ajax({
            type: 'POST',
            url: 'http://192.168.16.198:8866/erp/Document/DeleteDocument',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(data1),
            success: function (data) { //返回的结果自动放在resut里面了
                $.messager.alert({
                    title : '提示信息!',
                    msg : '删除成功!'
                });
            },
            error: function (e) {
                $.messager.alert({
                    title : '提示信息!',
                    msg : '删除失败!!'
                });
            },
        })
    }
    //附件下载
    function downfile() {
        var row = $('#datagrid2').datagrid('getSelected');
        var fid = row.fid;
        location.href = "http://192.168.16.198:8866/erp/Document/DownlodaDocument?fid="+ fid +"";
    }
    //附件下载操作
    function operate(val, row, rowIndex) {
            var str = "";
            str += "<a href='javascript:;' id='btndel" + rowIndex + "' onclick='downfile(" + row.rndetId + ")' class='btn btn-danger btn-mini'>下载</a>";
            return str;        
    }
    //下推
    function createShouNotice(){
            var rows = $("#datagrid").datagrid("getSelections");
            if (rows.length < 1) {
                $.messager.alert({
                    title : '提示信息!',
                    msg : '请选择需要操作的记录！!'
                });
                return false;
            }
            var rowData = $('#datagrid').datagrid('getSelected');
            if(rowData.chkState == 0){
                $.messager.alert({
                    title : '提示信息!',
                    msg : '此单未审核请审核后再操作！!'
                });
                return;
            }
            if(rowData.closeState == 1){
            $.messager.alert({
                        title : '提示信息!',
                        msg : '订单已关闭，无法下推!!'
                    });
                    return false;
            }
            // $("#supName2").val(rowData.supName);
            $("#contractNo2").val(rowData.contractNo);
            $("#puOrderDate1").val(puOrderDate);
            $("#purcManName1").val(rowData.purcManName);
            $("#payCondition1").combobox("setValue", rowData.payCondition);
            $("#tranAddress1").val(rowData.tranAddress);
            $("#tranType1").combobox("setValue", rowData.tranType);
            $("#takeWay1").combobox("setValue", rowData.takeWay);
            $("#deliveryType1").val(rowData.deliveryType);
            $("#payType1").combobox("setValue", rowData.payType);
            $("#invoiceType1").combobox("setValue", rowData.invoiceType);
            $("#makeWay1").val(rowData.makeWay);
            $("#rate").val(rowData.rate);
            $("#payCurrency1").combobox("setValue", rowData.payCurrency);
            $("#remark1").val(rowData.remark);
            $("#requirement1").val(rowData.requirement);
            $("#packing1").val(rowData.packing);
            $("#makeManName2").val(rowData.makeManName);
            $("#makeManId").val(rowData.makeManId);
            var createDate1 = patternDate(rowData.createDate)
            $("#createDate1").val(createDate1);
            $("#chkManName1").val(rowData.chkManName);
            var chkTime1 = patternDate(rowData.chkTime)
            $("#chkTime1").val(chkTime1);
            // alert(rowData.contractNo);
            $("#rnDate1").datebox("setValue",$('#rnDate1').datebox('options').currentText);      
            function getCurrentMonthFirst(){
                var date=new Date();
                date.setDate(date.getDate()+1);
                return date;
            }
            var AHDate = $("#AHDate1").val();
            var AHDate1 = getCurrentMonthFirst(AHDate);
            var AHdata1 = formatDate(AHDate1);
            $("#AHDate1").datebox("setValue",AHdata1);
            // alert(AHDate1);
            var contractNo = rowData.contractNo;
            var supid = getParameter("supid");
            var closeState = rowData.closeState;
            var isCancel = rowData.isCancel;
            var puOrderId = rowData.puOrderId;
            var itemNo = rowData.itemNo;

            for(var i=0;i<rows.length;i++){
                var rows = $("#datagrid").datagrid("getSelections");    
            }
            var aaa = [];
            aaa = rows;
            console.log(aaa);
            // var obj = {"total":data.Data.list.length,"rows":data.Data.list};   
            // $('#datagrid4').datagrid('loadData',obj);

            var data = {"total":aaa.length,"rows":aaa};    
            $('#datagrid4').datagrid('loadData', data);  
            $("#add").window("open"); 
    }
    //附件表格请求
    function upload(){
        var rows = $("#datagrid").datagrid("getSelections");
        for (var i = 0; i < rows.length; i++) {
                if (rows[0].puOrderId != rows[i].puOrderId) {
                    $.messager.alert({
                            title : '提示信息!',
                            msg : '请选择相同的订单进行操作!!'
                        });
                    return false;
                }
            }
            if (rows.length < 1) {
                $.messager.alert({
                    title : '提示信息!',
                    msg : '请选择需要操作的记录！!'
                });
                return false;
            }
        var rowData = $('#datagrid').datagrid('getSelected');
        var formId = rowData.puOrderId;
        var url = window.location.href;
        var uid = location.href.split('uid=')[1].split('&');
     
        $("#upl").attr("src","upload2/index.html?formId="+formId+"&uid="+uid+"&formKey=Purc_PurFormList");
        $("#file").window("open");
        $.ajax({
            url:'http://192.168.16.198:8866/erp/Document/GetDocumentInfo?formId='+ formId +'&formKey=Purc_PurFormList',
            type:'get',
            success: function (data) {
                // alert("ok");
                        var obj = {"total":data.Data.length,"rows":data.Data};   
                        $('#datagrid2').datagrid('loadData',obj);
                },
                error: function (e) {
                    $.messager.alert({
                            title : '提示信息!',
                            msg : '失败!!'
                        });
                },
            })
    }
    //格式化日期
    function myformatter(date){
			var y = date.getFullYear();
			var m = date.getMonth()+1;
			var d = date.getDate();
			return y+'-'+(m<10?('0'+m):m)+'-'+(d<10?('0'+d):d);
		}
		function myparser(s){
			if (!s) return new Date();
			var ss = (s.split('-'));
			var y = parseInt(ss[0],10);
			var m = parseInt(ss[1],10);
			var d = parseInt(ss[2],10);
			if (!isNaN(y) && !isNaN(m) && !isNaN(d)){
				return new Date(y,m-1,d);
			} else {
				return new Date();
			}
		}
        //格式化栏位
        function format_check(val, row) {
            if (val == 1)
                return "<span class='label label-success'>已审核<span>";
            else if (val == 2)
                return "<span class='label label-danger'>审核中<span>";
            else if (val == 3)
                return "<span class='label label-warning'>不通过<span>";
            else if (val == 0)
                return "<span class='label'>未审核<span>";
            else  
                return "";
        }
        function format_close(val, row) {
            if (val == 1)
                return "<span class='label'>关闭<span>";
            else if (val == 0)
                return "<span class='label label-success'>开启<span>";
            else    
                return "";
        }
        function fmt_payCurrency(val, row) {
            if (val == 1) {
                return "人民币";
            }
            else if (val == 2) {
                return "港元";
            }
            else if (val == 3) {
                return "欧元";
            }
            else if (val == 4) {
                return "美元";
            }
        }
        function fileType(val,row){
            if (val == 0) {
                return "其他";
            }
            else if (val == 1) {
                return "营业执照";
            }
            else if (val == 2) {
                return "开票资料";
            }
        }
        
        // 格式化时间方法，结果类型 yy-mm-dd
        function patternDate(date) {
            var d = new Date(date),
                    month = '' + (d.getMonth() + 1),
                    day = '' + d.getDate(),
                    year = d.getFullYear();
        
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }
        //默认日期为当前日期后一天
        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();
            
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            
            return [year, month, day].join('-');
        }
        //数值转换千分位,保留两位小数
        var twoNumber = function (val) {
            if (val == null || val == "") val = 0;
            val = parseFloat(val).toFixed(2);
            var source = String(val).split(".");//按小数点分成2部分
            source[0] = source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)', 'ig'), "$1,");//只将整数部分进行分割
            return source.join(".");//再将小数部分合并进来
        };
         //数值转换千分位,保留4位小数
         var thousandBit = function (num) {
            if (num != "" && num != undefined) {
                num = parseFloat(num).toFixed(4);
                if (num < 999) {
                    return num
                }
                var a = num.substring(0, num.length - 5).replace(/\B(?=(\d{3})+(?!\d))/g, ',')
                var b = num.substring(num.lastIndexOf("."))
                return a + b
            } else {
                return "";
            }
        };
        //纵向合并单元格
        function mergeCellsByField(tableID, colList) {
            var contractNo = colList.split(",");
            var tTable = $("#" + tableID);
            var TableRowCnts = tTable.datagrid("getRows").length;
            var tmpA;
            var tmpB;
            var PerTxt = "";
            var CurTxt = "";
            var buyprocode = "";
            var newbuyprocode = "";
            var alertStr = "";
            for (j = contractNo.length - 1; j >= 0; j--) {
                PerTxt = "";
                buyprocode = "";
                tmpA = 1;
                tmpB = 0;
 
                for (i = 0; i <= TableRowCnts; i++) {
                    if (i == TableRowCnts) {
                        CurTxt = "";
                        newbuyprocode = "";
                    }
                    else {
                        CurTxt = tTable.datagrid("getRows")[i][contractNo[j]];
                        newbuyprocode = tTable.datagrid("getRows")[i]["buyprojectCode"];
                    }
                    if (PerTxt == CurTxt && buyprocode == newbuyprocode) {
                        tmpA += 1;
                    }
                    else {
                        tmpB += tmpA;
 
                        tTable.datagrid("mergeCells", {
                            index: i - tmpA,
                            field: contractNo[j],　　//合并字段
                            rowspan: tmpA,
                            colspan: null
                        });
                        tTable.datagrid("mergeCells", { //根据ColArray[j]进行合并
                            index: i - tmpA,
                            field: "Ideparture",
                            rowspan: tmpA,
                            colspan: null
                        });
 
                        tmpA = 1;
                    }
                    PerTxt = CurTxt;
                    buyprocode = newbuyprocode;
                }
            }
        }
        var combinCol = 'supName,giveDate1,puOrderId';   
        //本页合计 
        function compute(colName) {
            var rows = $('#datagrid').datagrid('getRows');
            var total = 0;
            for (var i = 0; i < rows.length; i++) {
                total += parseFloat(rows[i][colName]);
            }
            return total;
        }
    $(function(){
        $('#datagrid').datagrid({
            onLoadSuccess: function (data) {  
                if (data.rows.length > 0) {
                    //调用mergeCellsByField()合并单元格
                    mergeCellsByField("datagrid", "contractNo,puOrderId");
                }
                var showNum = compute("showNum");
                var leviedTotal = compute("leviedTotal");
                var noRnNum = compute("noRnNum");
                var showUnit = '本页合计';
                var showUnit1 = '总合计';
                $('#datagrid').datagrid('appendRow', { 
                    showUnit: showUnit1,
                    showNum: sumShowNum,
                    leviedTotal:sumLeviedTotal,
                    noRnNum:sumNoRnNum,          
                });
                $('#datagrid').datagrid('appendRow', {
                    showUnit: showUnit,
                    showNum: showNum,
                    leviedTotal:leviedTotal,
                    noRnNum:noRnNum,  
                });
                var rows = $('#datagrid').datagrid('getRows');
                // $("#datagrid").datagrid('freezeRow', rows.length - 2);
                // $("#datagrid").datagrid('freezeRow', rows.length - 1);
            },
            onClickRow: function (rowIndex, rowData) {
                var rowData = $('#datagrid').datagrid('getSelected');
                if(rowData.contractNo == undefined){
                    $(this).datagrid('unselectRow', rowIndex);
                    return false;
                }
            },
        });
    $("#datagrid4").datagrid({
            columns:
                [
                    [
                            { title: '合同号', field: 'contractNo', width: 150, align: 'left', halign: 'center' },
                            { title: '物料名称', field: 'itemName', width: 270, align: 'left', halign: 'center' },
                            { title: '规格型号', field: 'itemSize', width: 270, align: 'left', halign: 'center' },
                            { title: '单位', field: 'showUnit', width: 100,  align: 'center', halign: 'center', },
                            { title: '预收数量', field: 'rdInNum', width: 100, align: 'right', halign: 'center',formatter:twoNumber,  editor: { type: 'numberbox', options: { precision: 2 } }},
                    ]
                ],
                onClickCell: function (rowIndex, field, value) {
                    $("#datagrid4").datagrid("beginEdit", rowIndex);
                    editIndex = rowIndex;
            },
        });
    $("#datagrid1").datagrid({
            columns:
                [
                    [
                            { title: '物料代码', field: 'itemNo', width: 180, align: 'left', halign: 'center' },
                            { title: '物料名称', field: 'itemName', width: 220, align: 'left', halign: 'center' },
                            { title: '规格型号', field: 'itemSize', width: 250, align: 'left', halign: 'center' },
                            { title: '幅宽(mm)', field: 'kuanDu', width: 100, align: 'right', halign: 'center' },
                            { title: '单位', field: 'showUnit', width: 70,  align: 'center', halign: 'center', },
                            { title: '数量', field: 'showNum', width: 100, align: 'right', halign: 'center',formatter:twoNumber,  editor: { type: 'numberbox', options: { precision: 2 } } },
                            { title: '含税价', field: 'taxPrice', width: 100, align: 'right', halign: 'center',formatter:twoNumber,  editor: { type: 'numberbox', options: { precision: 4 } }},
                            { title: '平方数', field: 'squareNum', width: 100, align: 'right', halign: 'center',formatter:twoNumber, editor: { type: 'numberbox', options: { precision: 2 }}},
                            { title: '平方价', field: 'squarePrice', width: 100, align: 'right', halign: 'center',formatter:twoNumber,  editor: { type: 'numberbox', options: { precision: 4 } } },
                            { title: '含税总额', field: 'leviedTotal', width: 100, align: 'right', halign: 'center',formatter:twoNumber,  editor: { type: 'numberbox', options: { precision: 2, disabled: true } } },
                            { title: '交货日期', field: 'giveDate1', width: 100, align: 'center', },  
                    ]
                ],
        });
    //双击行打开编辑窗体
    $('#datagrid').datagrid({
        loadMsg: "正在加载数据",
         showFooter: true,
            onDblClickRow: function (rowIndex, rowData) { //双击行
            if(rowData.contractNo == undefined){
                return false;
            }
            if(rowData.chkState == 1){
                var chkTime = patternDate(rowData.chkTime)
                $("#chkTime").val(chkTime);
            }
            $("#puOrderDate").datebox("setValue", rowData.puOrderDate);
            $("#dlg").dialog("open");   
            $("#supName1").val(rowData.supName);
            $("#contractNo1").val(rowData.contractNo);
            $("#purcManName").val(rowData.purcManName);
            $("#payCondition").combobox("setValue", rowData.payCondition);
            $("#tranAddress").val(rowData.tranAddress);
            $("#tranType").combobox("setValue", rowData.tranType);
            $("#takeWay").combobox("setValue", rowData.takeWay);
            $("#deliveryType").val(rowData.deliveryType);
            $("#payType").combobox("setValue", rowData.payType);
            $("#invoiceType").combobox("setValue", rowData.invoiceType);
            $("#makeWay").val(rowData.makeWay);
            $("#rate").val(rowData.rate);
            $("#payCurrency").combobox("setValue", rowData.payCurrency);
            $("#remark").val(rowData.remark);
            $("#requirement").val(rowData.requirement);
            $("#packing").val(rowData.packing);
            $("#makeManName1").val(rowData.makeManName);
            var createDate = patternDate(rowData.createDate)
            $("#createDate").val(createDate);
            $("#chkManName").val(rowData.chkManName);
            
            // alert(rowData.contractNo);
            var contractNo = rowData.contractNo;
            var supid = getParameter("supid");
            var closeState = rowData.closeState;
            var isCancel = rowData.isCancel;
            var itemNo = rowData.itemNo;
            var itemSize = rowData.itemSize;
            var makeManName = rowData.makeManName;
            var chkState = rowData.chkState;
            var closeState = rowData.closeState;
            $.ajax({
                    url:'http://192.168.16.198:8866/erp/PurchaseOrder/GetOrderInfo?supid='+ supid +'&itemNo=%20&itemSize=%20&contractNo='+ contractNo +'&pageIndex=1&pageSize=50&makeManName=%20&beginDate=%20&endDate=%20&chkState=99&closeState=99&isCancel=99',
                    type:'get',
                    success: function (data) {
                        // alert("ok");
                        var obj = {"total":data.Data.list.length,"rows":data.Data.list};   
                        $('#datagrid1').datagrid('loadData',obj);
                    },
                    error: function (e) {
                        $.messager.alert({
                            title : '提示信息!',
                            msg : '失败!!'
                        });
                },
            })
        },             
    });
})
//付款方式
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetPaymentList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　　　　　//combobox操作
    $('#payCondition').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetPaymentList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　　　　　//combobox操作
    $('#payCondition1').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//运输方式
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetTransportList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　　　　　//combobox操作
    $('#tranType').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//运输方式
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetTransportList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　　　　　//combobox操作
    $('#tranType1').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//提货方式
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetPickGoodsList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　　　　　//combobox操作
    $('#takeWay').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//提货方式
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetPickGoodsList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　　　　　//combobox操作
    $('#takeWay1').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//结算方式
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetClearingTypeList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　　　　　//combobox操作
    $('#payType').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//结算方式
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetClearingTypeList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　　　　　//combobox操作
    $('#payType1').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//发票类型
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetInvoiceTypeList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　//combobox操作
    $('#invoiceType').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//发票类型
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
    //先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",
        url:"http://192.168.16.198:8866/erp/SharedData/GetInvoiceTypeList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　//combobox操作
    $('#invoiceType1').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//币种
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
   // 先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
        url:"http://192.168.16.198:8866/erp/SharedData/GetCurrencyList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　//combobox操作
    $('#payCurrency').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//币种
var arrayData  = new Array();//创建空数组
$(document).ready(function(){
   // 先用ajax获取到下拉框全部的数据，并放到数组一里
    $.ajax({
        async:false,//同步加载
        type:"get",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
        url:"http://192.168.16.198:8866/erp/SharedData/GetCurrencyList",
        dataType:"json",
        success: function(data){
            arrayData = data.Data
        }
    });  
　　//combobox操作
    $('#payCurrency1').combobox({　
        valueField: 'dictNo',
        textField: 'dict',
        data:arrayData,
    });
});
//截取字符串后面的参数
function getParameter(name){
   var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)"); //构建一个含有目标参数的正则表达式对象     
   var r = window.location.search.substr(1).match(reg);//匹配目标参数  
   if(r!=null) {
      return unescape(r[2]); //返回参数值  
   }
      return null;
}	

  
var sumLeviedTotal = 0;
var sumNoRnNum = 0;
var sumShowNum=0;
//查询
function select(){
    var pageIndex = $('#datagrid').datagrid('options').pageNumber;//pageNumber为datagrid的当前页码
    var pageSize = $('#datagrid').datagrid('options').pageSize;//多少条数据
    var supid = getParameter("supid");
    var chkState = $("#chkState").val();
    var isCancel = $("#isCancel").val();
    var closeState = $("#closeState").val();
    var makeManName = $("#makeManName").val();
    var contractNo = $("#contractNo").val();
    var begindate = $('#begindate').datebox('getValues');
    var enddate = $('#enddate').datebox('getValues');
    var itemNo = $("#itemNo").val();
    var itemSize = $("#itemSize").val();
    var pg = $("#datagrid").datagrid("getPager");  
        if(pg)  
        {  
            $(pg).pagination({  
                onBeforeRefresh:function(){  
                   // alert('before refresh');  
                },  
                onRefresh:function(pageNumber,pageSize){   
                    $.ajax({
                    url:'http://192.168.16.198:8866/erp/PurchaseOrder/GetOrderInfo?supId='+ supid
                    +'&itemNo='+ itemNo 
                    +'&itemSize='+ itemSize 
                    +'&contractNo='+ contractNo 
                    +'&pageIndex='+ pageIndex 
                    +'&pageSize='+ pageSize 
                    +'&makeManName='+ makeManName 
                    +'&begindate='+ begindate 
                    +'&enddate='+ enddate 
                    +'&chkState='+ chkState 
                    +'&closeState='+ closeState 
                    +'&isCancel='+ isCancel +'',
                    type:'get',
                    success: function (data) {
                        // alert("ok");
                                var obj = {"total":data.Data.list.length,"rows":data.Data.list};   
                                $('#datagrid').datagrid('loadData',obj);
                        },
                        error: function (e) {
                            $.messager.alert({
                                        title : '提示信息!',
                                        msg : '失败!!'
                                    });
                        },
                    })
                },  
                onChangePageSize:function(){  
                    $.ajax({
                    url:'http://192.168.16.198:8866/erp/PurchaseOrder/GetOrderInfo?supId='+ supid
                    +'&itemNo='+ itemNo 
                    +'&itemSize='+ itemSize 
                    +'&contractNo='+ contractNo 
                    +'&pageIndex='+ pageIndex 
                    +'&pageSize='+ pageSize 
                    +'&makeManName='+ makeManName 
                    +'&begindate='+ begindate 
                    +'&enddate='+ enddate 
                    +'&chkState='+ chkState 
                    +'&closeState='+ closeState 
                    +'&isCancel='+ isCancel +'',
                    type:'get',
                    success: function (data) {
                        // alert("ok");
                                var obj = {"total":data.Data.list.length,"rows":data.Data.list};   
                                $('#datagrid').datagrid('loadData',obj);
                        },
                        error: function (e) {
                            $.messager.alert({
                                        title : '提示信息!',
                                        msg : '失败!!'
                                    });
                        },
                    })
                },  
                onSelectPage:function(pageNumber,pageSize){  
                    var pageIndex1 = pageNumber;
                    $.ajax({
                    url:'http://192.168.16.198:8866/erp/PurchaseOrder/GetOrderInfo?supId='+ supid
                    +'&itemNo='+ itemNo 
                    +'&itemSize='+ itemSize 
                    +'&contractNo='+ contractNo 
                    +'&pageIndex='+ pageIndex1 
                    +'&pageSize='+ pageSize 
                    +'&makeManName='+ makeManName 
                    +'&begindate='+ begindate 
                    +'&enddate='+ enddate 
                    +'&chkState='+ chkState 
                    +'&closeState='+ closeState 
                    +'&isCancel='+ isCancel +'',
                    type:'get',
                    success: function (data) {
                        // alert("ok");
                                var obj = {"total":data.Data.list.length,"rows":data.Data.list};   
                                $('#datagrid').datagrid('loadData',obj);
                        },
                        error: function (e) {
                            $.messager.alert({
                                        title : '提示信息!',
                                        msg : '失败!!'
                                    });
                        },
                    })
                }  
            });  
 } 
    $.ajax({
    url:'http://192.168.16.198:8866/erp/PurchaseOrder/GetOrderInfo?supId='+ supid
      +'&itemNo='+ itemNo 
      +'&itemSize='+ itemSize 
      +'&contractNo='+ contractNo 
      +'&pageIndex='+ pageIndex 
      +'&pageSize='+ pageSize 
      +'&makeManName='+ makeManName 
      +'&begindate='+ begindate 
      +'&enddate='+ enddate 
      +'&chkState='+ chkState 
      +'&closeState='+ closeState 
      +'&isCancel='+ isCancel +'',
     type:'get',
     success: function (data) {
        // alert("ok");
        if(data.Data.Sum){
            sumLeviedTotal = data.Data.Sum.sumLeviedTotal;
            sumNoRnNum = data.Data.Sum.sumNoRnNum;
            sumShowNum=data.Data.Sum.sumShowNum;
        }
            var obj = {"total":data.Data.list.length,"rows":data.Data.list};   
            $('#datagrid').datagrid('loadData',obj);
            $('#datagrid').datagrid('reload'); 
        },
        error: function (e) {
            $.messager.alert({
                        title : '提示信息!',
                        msg : '失败!!'
                    });
        },
    })
}    
//复位
function tjClear(){
    $("#closeState").val("0");
    $("#isCancel").val("0");
    $("#itemNo").val("");
    $("#contractNo").val("");
    $("#makeManName").val("");
    $("#itemSize").val("");
}
//关闭下推页面
 function closesd(){
    $("#add").window("close");
 }
//下推保存
function XTsave(){
        if($("#plateNumbers").val() == ""){
            $.messager.alert({
                title : '提示信息!',
                msg : '请填写车牌号!!'
            });
            return false;
        }
        if($("#driverPhone").val() == ""){
            $.messager.alert({
                title : '提示信息!',
                msg : '请填写司机电话!!'
            });
            return false;
        }
        if($("#remark1").val() == ""){
            $.messager.alert({
                title : '提示信息!',
                msg : '请填写备注!!'
            });
            return false;
        }
        var rowData = $('#datagrid').datagrid('getSelected');
        var giveDate = rowData.giveDate1;
        // var closeTime = formatDate(rowData.closeTime);
        // var operateTime = formatDate(rowData.operateTime);
        var AHDate = $('#AHDate1').datebox('getValue');
        var rnDate = $('#rnDate1').datebox('getValue');
        var chkTime = formatDate(rowData.chkTime);
        var createDate = formatDate(rowData.createDate);
        //alert(closeTime);
        var plateNumbers = $("#plateNumbers").val();
        var driverPhone = $("#driverPhone").val();
        var makeManId = rowData.makeManId;
        var makeManName = $("#makeManName2").val();
        var remark = $("#remark1").val();
        var supid = rowData.supId;
        var supName = rowData.supName;
        var puOrderId = rowData.puOrderId;
        var puOrderDetailId = rowData.puOrderDetailId;
        // 将 dataGrid 所有的行都结束编辑
        var rows=$('#datagrid4').datagrid('getChecked');   //  选择要提交的数据
        var endRows = $('#datagrid4').datagrid("getRows");// 获取所有的行，并且结束掉编辑
        for(var i =0; i < endRows.length; i++){
             $('#datagrid4').datagrid('endEdit', i);
        }
        for(var i =0; i < endRows.length; i++){
                if(endRows[i].rdInNum == undefined){
                    $.messager.alert({
                        title : '提示信息!',
                        msg : '请填写预收数量!!'
                    });
                    return false;
                }
            }
        var arr = [];
        for (var i = 0, j = endRows.length; i < j; i++) {
            var obj = new Object();
            obj.giveDate = endRows[i].giveDate;
            // obj.operateTime = endRows[i].operateTime;
            obj.puOrderId = endRows[i].puOrderId;
            obj.puOrderDetailId = endRows[i].puOrderDetailId;
            obj.rdInNum = endRows[i].rdInNum;
            arr.push(obj);
        }
        console.log(arr);       
        var obj2 = new Object();
        obj2.rnDate=rnDate;
        obj2.AHDate=AHDate;
        obj2.chkTime=chkTime;
        obj2.createDate=createDate;
        // obj2.operateTime=operateTime;
        obj2.plateNumbers=plateNumbers;
        obj2.driverPhone=driverPhone;
        obj2.makeManId=makeManId;
        obj2.makeManName=makeManName;
        obj2.supid=supid;
        obj2.supName=supName;
        obj2.remark=remark;
        $.ajax({    
            type:'POST',
            url:'http://192.168.16.198:8866/erp/PurchaseOrder/PushReceipt',
            data : {
                "MainFormDate":obj2,
                "FormDate":arr
            },
            success: function (data) {
                $.messager.alert({
                        title : '提示信息!',
                        msg : '成功!!'
                    });
                setTimeout(function () {
                    $("#add").window("close");
                },2000);
            },
            error: function (e) {
                $.messager.alert({
                        title : '提示信息!',
                        msg : '失败!!'
                    });
            },
        })    
}
</script>
</body>
</html>